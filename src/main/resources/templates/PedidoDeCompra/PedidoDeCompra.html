<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{index.html}"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.ultraq.net.nz/thymeleaf/layout ">

<head>
  <meta charset="UTF-8" />
  <title>Pedido De Compra</title>
</head>

<body>
  <div layout:fragment="content">
    <div class="row" id="Cr-Producto-Datos">
      <div class="col-xl-8 col-lg-8 col-md-8 col-sm-8">
          <div class="mb-5">
              <div class="card card-custom card-outline card-sistema">
                  <!--begin::Header-->
                  <div class="card-header flex-wrap border-0 pt-6 pb-0">
                      <h3 class="card-title align-items-start flex-column">
                          <span class="card-label font-weight-bolder text-dark">Pedido de Compra</span>
                          <span class="text-muted mt-1 font-weight-bold font-size-sm">Cree un nuevo Pedido de Compra.</span>
                      </h3>
                      <div class="card-toolbar">
                      </div>
                  </div>
                  <!--end::Header-->
                  <!--begin::Body-->
                  <div class="card-body">
                      <div class="row">
                          <div class="col-sm-1 col-md-2 col-lg-3 col-xl-3">
                              <h3>Numero Pedido <span class="text-danger">#00000001</span></h3>
                          </div>
                      </div>
                      <div class="row">
                          <div class="col-sm-1 col-md-3 col-lg-4 col-xl-4">
                              <div class="" id="C-SLProveedor">
                                  <label class="control-label">Proveedor</label>
                                  <select id="SLProveedor" class="select2 select2-sischef" data-content-id="C-SLProveedor" data-content-option="select2-SLProveedor-container" data-dropdown-css-class="select2-sischef" data-valida="true">
                                      <option></option>
                                  </select>
                              </div>
                          </div>
                          <div class="col-sm-1 col-md-3 col-lg-4 col-xl-4">
                              <div class="" id="C-SLDireccion">
                                  <label class="control-label">Direccion</label>
                                  <input class="form-control form-control-sm" type="text" id="txt_fec_naci" data-valida="true" >
                              </div>
                          </div>
                          <div class="col-sm-1 col-md-1 col-lg-1 col-xl-2">
                              <div class="" id="C-SLMoneda">
                                  <label class="control-label">Moneda</label>
                                  <select id="SLMoneda" class="select2 select2-sischef" data-content-id="C-SLMoneda" data-content-option="select2-SLMoneda-container" data-dropdown-css-class="select2-sischef" data-valida="true">
                                      <option></option>
                                  </select>
                              </div>
                          </div>
                          <div class="col-sm-1 col-md-1 col-lg-2 col-xl-2">
                            <div class="" id="C-SLDireccion">
                                <label class="control-label">Factor Cambio</label>
                                <input class="form-control form-control-sm text-rigth" type="number" id="txt_fec_naci" data-valida="true" disabled>
                            </div>
                        </div>
                          <div class="col-sm-1 col-md-3 col-lg-3 col-xl-3">
                              <div class="" id="C-SLCondicionPago">
                                  <label class="control-label">Condicion de Pago</label>
                                  <select id="SLCondicionPago" class="select2 select2-sischef" data-content-id="C-SLCondicionPago" data-content-option="select2-SLCondicionPago-container" data-dropdown-css-class="select2-sischef" data-valida="true">
                                      <option></option>
                                  </select>
                              </div>
                          </div>
                          <div class="col-sm-1 col-md-3 col-lg-4 col-xl-4">
                              <div class="" id="C-SLAlmacen">
                                  <label class="control-label">Almacen</label>
                                  <select id="SLAlmacen" class="select2 select2-sischef" data-content-id="C-SLAlmacen" data-content-option="select2-SLAlmacen-container" data-dropdown-css-class="select2-sischef" data-valida="true">
                                      <option></option>
                                  </select>
                              </div>
                          </div>
                          <div class="col-sm-1 col-md-4 col-lg-2">
                            <div class="form-group">
                              <label class="control-label">Fecha Emisión</label>
                              <input class="form-control form-control-sm" type="date" id="txt_fec_naci" data-valida="true">
                            </div>
                          </div>
                          <div class="col-sm-1 col-md-4 col-lg-2">
                            <div class="form-group">
                              <label class="control-label">Fecha Expiración</label>
                              <input class="form-control form-control-sm" type="date" id="txt_fec_naci" data-valida="true">
                            </div>
                          </div>
                          <div class="col-sm-1 col-md-3 col-lg-4 col-xl-12">
                            <div class="" id="C-SLDireccion">
                                <label class="control-label">Observacion</label>
                                <input class="form-control form-control-sm" type="text" id="txt_fec_naci" data-valida="true" >
                            </div>
                        </div>
                      </div>
  
  
  
                  </div>
  
              </div>
          </div>
  
          <div class="">
              <div class="card card-custom card-outline card-sistema">
                  <!--begin::Header-->
                  <div class="card-header flex-wrap border-0 pt-6 pb-0">
                      <h3 class="card-title align-items-start flex-column">
                          <span class="card-label font-weight-bolder text-dark">Detalle del Pedido</span>
                          <span class="text-muted mt-1 font-weight-bold font-size-sm"></span>
                      </h3>
                      <div class="card-toolbar">
                          <div class="dropdown dropdown-inline mr-2">
                              <button type="button" class="btn btn-light-success font-weight-bolder dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                  <span class="svg-icon svg-icon-md">
                                      <svg xmlns="http://www.w3.org/2000/svg"
                                           xmlns:xlink="http://www.w3.org/1999/xlink"
                                           width="24px"
                                           height="24px"
                                           viewBox="0 0 24 24"
                                           version="1.1">
                                          <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                              <rect x="0" y="0" width="24" height="24"></rect>
                                              <path d="M5,8.6862915 L5,5 L8.6862915,5 L11.5857864,2.10050506 L14.4852814,5 L19,5 L19,9.51471863 L21.4852814,12 L19,14.4852814 L19,19 L14.4852814,19 L11.5857864,21.8994949 L8.6862915,19 L5,19 L5,15.3137085 L1.6862915,12 L5,8.6862915 Z M12,15 C13.6568542,15 15,13.6568542 15,12 C15,10.3431458 13.6568542,9 12,9 C10.3431458,9 9,10.3431458 9,12 C9,13.6568542 10.3431458,15 12,15 Z"
                                                    fill="#000000"></path>
                                          </g>
                                      </svg>
                                  </span>
                              </button>
                              <!--begin::Dropdown Menu-->
                              <div class="dropdown-menu dropdown-menu-sm dropdown-menu-right">
                                  <!--begin::Navigation-->
                                  <ul class="navi flex-column navi-hover py-2">
                                      <li class="navi-header font-weight-bolder text-uppercase font-size-sm text-primary pb-2">Seleccione una Opcion:</li>
                                      <li class="navi-item">
                                          <a href="#" class="navi-link">
                                              <span class="navi-icon">
                                                  <i class="la la-eye"></i>
                                              </span>
                                              <span class="navi-text">Vista Previa</span>
                                          </a>
                                      </li>
                                      <li class="navi-item">
                                          <a href="#" class="navi-link">
                                              <span class="navi-icon">
                                                  <i class="la la-file-text-o"></i>
                                              </span>
                                              <span class="navi-text">CSV</span>
                                          </a>
                                      </li>
                                      <li class="navi-item">
                                          <a href="#" class="navi-link">
                                              <span class="navi-icon">
                                                  <i class="la la-file-pdf-o"></i>
                                              </span>
                                              <span class="navi-text">PDF</span>
                                          </a>
                                      </li>
                                  </ul>
                                  <!--end::Navigation-->
                              </div>
                              <!--end::Dropdown Menu-->
                          </div>
                      </div>
                  </div>
                  <!--end::Header-->
                  <!--begin::Body-->
                  <div class="card-body">
                      <table id="TblProducto" class="table table-separate table-head-custom dataTable no-footer dtr-inline" cellspacing="0" width="100%">
                          <thead>
                              <tr>
                                  <th></th>
                                  <th>Codigo</th>
                                  <th>Nombre</th>
                                  <th>Cantidad</th>
                                  <th>Precio</th>
                                  <th>Detalle</th>
                              </tr>
                          </thead>
                          <tbody>
                          </tbody>
                      </table>
                  </div>
  
              </div>
          </div>
  
  
      </div>
  
  
      <div class="col-xl-4 col-lg-4 col-md-4 col-sm-4">
          <div class="card card-custom card-outline card-sistema card-stretch">
              <!--begin::Header-->
              <div class="card-header flex-wrap border-0 pt-6 pb-0">
                  <h3 class="card-title align-items-start flex-column">
                      <span class="card-label font-weight-bolder text-dark">Listado de Productos</span>
                      <span class="text-muted mt-1 font-weight-bold font-size-sm">Seleccione los productos para el pedio.</span>
                  </h3>
                  <div class="card-toolbar">
                      <a class="btn btn-light-primary font-weight-bold" id="BtnFiltroProducto">
                          <i class="fas fa-filter"></i> Filtrar
                      </a>
                  </div>
              </div>
              <!--end::Header-->
              <!--begin::Body-->
              <div class="card-body">
                  <div class="form-group">
                      <label class="control-label">Buscar</label>
                      <div class="input-group">
                          <input id="TxtBusqProducto" type="text" class="form-control input-search" placeholder="Buscar por...">
                          <div class="input-group-append">
                              <button id="BtnBusqProducto" class="btn btn-light-primary" type="button"><i class="fas fa-search"></i></button>
                          </div>
                      </div>
                  </div>
                  <div id="CListProductos" style="height:500px; overflow:auto">
                      <div id="CVacio" class="d-flex flex-column justify-content-center">
                          <span class="text-center text-dark-25" style="font-size: 5rem;"><i class="fas fa-plus-square"></i></span>
                          <span class="text-center text-dark-25 font-weight-bold" style="font-size: 1.5rem;">Agregar productos al pedido de compra</span>
                      </div>
                  </div>
  
              </div>
  
          </div>
      </div>
  </div>
  </div>

  <div layout:fragment="scripts">
    <script>
      
      VGlobal.actualizar = false;
      
      const TblProducto = $('#TblProducto').DataTable({
            columns: [
                { data: null,
                  render: function () {
                  return `
                           <a href="javascript:;" class="btn btn-sm btn-clean btn-icon delete" title="Eliminar">
                             <span class="svg-icon svg-icon-danger svg-icon-md">
                                <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                                   <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                       <rect x="0" y="0" width="24" height="24"></rect>
                                         <path d="M6,8 L6,20.5 C6,21.3284271 6.67157288,22 7.5,22 L16.5,22 C17.3284271,22 18,21.3284271 18,20.5 L18,8 L6,8 Z" fill="#000000" fill-rule="nonzero"></path>
                                         <path d="M14,4.5 L14,4 C14,3.44771525 13.5522847,3 13,3 L11,3 C10.4477153,3 10,3.44771525 10,4 L10,4.5 L5.5,4.5 C5.22385763,4.5 5,4.72385763 5,5 L5,5.5 C5,5.77614237 5.22385763,6 5.5,6 L18.5,6 C18.7761424,6 19,5.77614237 19,5.5 L19,5 C19,4.72385763 18.7761424,4.5 18.5,4.5 L14,4.5 Z" fill="#000000" opacity="0.3"></path>
                                    </g>
                                 </svg>
                               </span>
                            </a>
                        `
                }
                },
                { data: 'codProd' },
                { data: 'nomProd' },
                { 
                    data: null,
                    defaultContent: '<input class="form-control form-control-sm text-right" type="text" id="" name="" value="">'
                },
                { 
                    data: null,
                    defaultContent: '<input class="form-control form-control-sm text-right" type="text" id="" name="" value="">'
                 },
                 {
                    className: 'datatable-toggle-detail',
                    defaultContent: '<a class="datatable-toggle-detail" href=""><i class="fa fa-caret-down"></i></a>',
                    data: null,
                    orderable: false
                },
            ],
            language: VGlobal.table_es,
            "scrollX": true
        });
        LlenarTabla()


        $('#TblProducto tbody').on('click', 'td.datatable-toggle-detail', function (e) {
            e.preventDefault();
            console.log(this);
            var tr = $(this).closest('tr'),
                row = TblProducto.row(tr);

            if (row.child.isShown()) {
                tr.next('tr').removeClass('details-row');
                row.child.hide();
                tr.removeClass('shown');
            }
            else {
                row.child(format(row.data())).show();
                tr.next('tr').addClass('details-row');
                tr.addClass('shown');
            }
        });

        function format(data) {
            return '<div class="details-container">' +
                '<table cellpadding="5" cellspacing="0" border="0" class="details-table">' +
                '<tr>' +
                '<td class="title">Site ID:</td>' +
                '<td>' + data.CCOD_PROD + '</td>' +
                '</tr>' +
                '<tr>' +
                '<td class="title">Install Name:</td>' +
                '<td>' + data.CDES_CORT + '</td>' +
                '<td class="title">Business Name:</td>' +
                '<td>' + data.CCOD_PROD + '</td>' +
                '</tr>' +
                '<tr>' +
                '<td class="title">Yellow Pages URL:</td>' +
                '<td>' + data.CDES_CORT + '</td>' +
                '<td class="title">Facebook URL:</td>' +
                '<td>' + data.CDES_CORT + '</td>' +
                '</tr>' +
                '</table>' +
                '</div>';
        };

      let SLProveedor = $("#SLProveedor").select2({
        allowClear: true,
        placeholder: "Seleccione Proveedor",
        width: "100%",
        data: CargarAlmacenes()
      });
        
      let SLAlmacen = $("#SLAlmacen").select2({
        allowClear: true,
        placeholder: "Seleccione Almacen",
        width: "100%",
        data: CargarAlmacenes()
      });

      let SLMoneda = $("#SLMoneda").select2({
        allowClear: true,
        placeholder: "Seleccione Moneda",
        width: "100%",
        data: CargarMonedas()
      });

      let SLCondicionPago = $("#SLCondicionPago").select2({
        allowClear: true,
        placeholder: "Seleccione Condicion Pago",
        width: "100%",
        data: CargarCondicionPago()
      });

      function CargarAlmacenes() {
        let data
        $.ajax({
          type: "GET",
          url: `pedidoCompra/cargarAlmacenes`,
          async: false,
          dataType: "json",
          success: function (response) {
            data = response.lista;
          }
        });
        return data;
      }
      function CargarMonedas() {
        let data
        $.ajax({
          type: "GET",
          url: `pedidoCompra/cargarMonedas`,
          async: false,
          dataType: "json",
          success: function (response) {
            data = response.lista;
          }
        });
        return data;
      }
      function CargarCondicionPago() {
        let data
        $.ajax({
          type: "GET",
          url: `pedidoCompra/cargarCondicionesPago`,
          async: false,
          dataType: "json",
          success: function (response) {
            data = response.lista;
          }
        });
        return data;
      }
      
      function LlenarTabla() {
            $.ajax({
                type: "GET",
                url: `producto/listar`,
                dataType: "json",
                success: function (response) {
                  TblProducto.clear().rows.add(response.lista).columns.adjust().draw();
                }
            });
        }


      $('#btn_grabar').click((e) => {
        if (VGlobal.actualizar == true) {
              Actualizar();
           } else {
              Grabar();
          }  
      });

      function Grabar() {
        let metodo = function () {
          $.ajax({
              type: "POST",
              url: `producto/insertar`,
              data: {
                queryData: JSON.stringify({
                  codProd: $("#txt_cod_prod").val(),
                  nomProd: $("#txt_nom_prod").val(),
                  codBarrProd: $("#txt_cod_barr").val(),
                  skuProd: $("#txt_sku").val(),
                  indExpi: $('#chk_ind_expi').is(':checked') == true ? "S" : "N",
                  codBarrProd: $("#txt_cod_barr").val(),
                  fecExpi: $("#txt_fec_expi").val(),
                  codCompProd: $("#txt_cod_comp").val(),
                  impCost: $("#txt_imp_cost").val(),
                  estado: $('input:radio[name=rdb_estado]:checked').val()
                }),
                IdCate: $('#SLCategoria').select2('data').length == 0 ? "" : $('#SLCategoria').select2('data')[0].id,
                IdMarca: $('#SLMarca').select2('data').length == 0 ? "" : $('#SLMarca').select2('data')[0].id,
                IdUnme: $('#SLUnidadMedida').select2('data').length == 0 ? "" : $('#SLUnidadMedida').select2('data')[0].id,
              
              },
              dataType: "json",
              async: false,
              success: function (response) {
                 TblProducto.clear().rows.add(response.lista).columns.adjust().draw();
                 LimpiarCampos();
              }
          });
        }
        FGlobal.Confirmacion("¿Desea Grabar el Producto?", metodo);   
      }


      function Actualizar() {
        let metodo = function () {
          $.ajax({
              type: "POST",
              url: `producto/actualizar`,
              data: {
                queryData: JSON.stringify({
                  id: $("#txt_id_prod").val(),
                  codProd: $("#txt_cod_prod").val(),
                  nomProd: $("#txt_nom_prod").val(),
                  codBarrProd: $("#txt_cod_barr").val(),
                  skuProd: $("#txt_sku").val(),
                  indExpi: $('#chk_ind_expi').is(':checked') == true ? "S" : "N",
                  codBarrProd: $("#txt_cod_barr").val(),
                  fecExpi: $("#txt_fec_expi").val(),
                  codCompProd: $("#txt_cod_comp").val(),
                  impCost: $("#txt_imp_cost").val(),
                  estado: $('input:radio[name=rdb_estado]:checked').val()
                }),
                IdCate: $('#SLCategoria').select2('data').length == 0 ? "" : $('#SLCategoria').select2('data')[0].id,
                IdMarca: $('#SLMarca').select2('data').length == 0 ? "" : $('#SLMarca').select2('data')[0].id,
                IdUnme: $('#SLUnidadMedida').select2('data').length == 0 ? "" : $('#SLUnidadMedida').select2('data')[0].id,
              
              },
              dataType: "json",
              async: false,
              success: function (response) {
                 TblProducto.clear().rows.add(response.lista).columns.adjust().draw();
                 LimpiarCampos();
              }
          });
        }
        FGlobal.Confirmacion("¿Desea Actualizar el Producto?", metodo);
        
      }

    </script>
  </div>
</body>

</html>